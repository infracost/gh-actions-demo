on: [pull_request]
jobs:
  infracost:
    runs-on: ubuntu-latest
    env:
      working-directory: terraform

    name: Run Infracost
    steps:
      - name: Setup Infracost
        run: |
          curl -o /tmp/infracost https://infracost-public-dumps.s3.amazonaws.com/builds/json/infracost-linux-amd64 
          chmod +x /tmp/infracost
          /tmp/infracost configure set api_key ${{ secrets.INFRACOST_API_KEY }}

      - name: Checkout base branch
        uses: actions/checkout@v2
        with:
          ref: '${{ github.event.pull_request.base.ref }}'

      - name: Generate Infracost cost estimate baseline
        run: |
          /tmp/infracost breakdown --path=terraform \
                              --usage-file infracost-usage.yml \
                              --format=json \
                              --out-file=/tmp/infracost-base.json

      - name: Checkout PR branch
        uses: actions/checkout@v2

      - name: Run Infracost
        run: |
          /tmp/infracost diff --path=terraform \
                        --usage-file infracost-usage.yml \
                        --format=json \
                        --compare-to=/tmp/infracost-base.json \
                        --out-file=/tmp/infracost.json

      # See https://www.infracost.io/docs/features/cli_commands/#comment-on-pull-requests for other options.
      - name: Show json metadata
        run: |
          echo "run breakdown on master"
          cat /tmp/infracost-base.json | jq ".projects[0].metadata"
          echo "run diff on branch"
          cat /tmp/infracost.json | jq ".projects[0].metadata"
