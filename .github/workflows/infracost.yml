on: [push]
jobs:
  infracost:
    runs-on: ubuntu-latest
    env:
      working-directory: terraform

    name: Run Infracost
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      # Run Terraform
      - name: Install terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_wrapper: false # This is recommended so the `terraform show` command outputs valid JSON

      - name: Terraform init
        run: terraform init
        working-directory: ${{ env.working-directory }}

      - name: Terraform plan
        run: terraform plan -out tfplan.binary
        working-directory: ${{ env.working-directory }}

      - name: Terraform show
        run: terraform show -json tfplan.binary > plan.json
        working-directory: ${{ env.working-directory }}

      # Run Infracost
      - name: Setup Infracost
        run: |
          curl -L https://github.com/hugorut/infracost/releases/download/v0.9.21/infracost-linux-amd64 -o infracost
          chmod +x infracost
          echo "{path}" >> $GITHUB_PATH
          infracost configure set api_key ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate Infracost JSON
        run: |
          infracost breakdown --path ./terraform/plan.json \
            --format json \ 
            --usage-file infracost-usage.yml \
            --out-file /tmp/infracost.json 

      # Post the comment
      - name: Post Infracost comment
        run: |
          infracost comment github \
              --pull-request ${{ github.event.number }} \
              --repo infracost/gh-actions-demo \
              --github-token ${{ secrets.GITHUB_TOKEN }} \
              --path /tmp/infracost.json \
              --policy-path cost-policy.rego 
